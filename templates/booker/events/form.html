{% extends "booker/_booker_base.html" %}

{% block title %}
    {% if event.Event_Name %}Edit Event: {{ event.Event_Name }}{% else %}Create New Event{% endif %}
{% endblock %}

{% block content %}
    <div class="header-bar">
        <h2>{% if event.Event_Name %}Edit Event{% else %}Create New Event{% endif %}</h2>
        <div class="action-buttons">
             <a href="{{ url_for('events.list_events') }}">Back to List</a>
        </div>
    </div>
    
    {% if event.Finalized %}
    <div class="notice-bar notice-info">
        <p><strong>Event Finalized:</strong> This event has been finalized and its records are permanent. It can no longer be edited.</p>
    </div>
    {% endif %}

    <form class="wide-form" method="POST" action="{{ url_for('events.create_event') if not event.Event_Name else url_for('events.edit_event', event_name=original_name) }}">
        <fieldset class="form-section" {% if event.Finalized %}disabled{% endif %}>
            <legend>Event Details</legend>
            <div class="form-group">
                <label for="event_name">Event Name <span class="required">*</span></label>
                <input type="text" id="event_name" name="event_name" value="{{ event.Event_Name | default('') }}" required>
            </div>
            <div class="form-group">
                <label for="subtitle">Subtitle</label>
                <input type="text" id="subtitle" name="subtitle" value="{{ event.Subtitle | default('') }}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="date">Date <span class="required">*</span></label>
                    <input type="date" id="date" name="date" value="{{ event.Date | default('') }}" required>
                </div>
                <div class="form-group">
                    <label for="status">Status <span class="required">*</span></label>
                    <select id="status" name="status" required>
                        <option value="">--Select Status--</option>
                        {% for status in status_options %}
                            <option value="{{ status }}" {% if event.get('Status', '') == status %}selected{% endif %}>{{ status }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
             <div class="form-row">
                <div class="form-group">
                    <label for="venue">Venue</label>
                    <input type="text" id="venue" name="venue" value="{{ event.Venue | default('') }}">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" value="{{ event.Location | default('') }}">
                </div>
            </div>
             <div class="form-group">
                <label for="broadcasters">Broadcasters</label>
                <input type="text" id="broadcasters" name="broadcasters" value="{{ event.Broadcasters | default('') }}">
            </div>
        </fieldset>
         <div class="action-buttons form-actions">
            {% if not event.Finalized %}
            <button type="submit" class="btn btn-primary">
                {% if event.Event_Name %}Update Event Details{% else %}Create Event{% endif %}
            </button>
            {% endif %}
        </div>
    </form>

    {% if event.Event_Name %}
    <hr class="section-divider">
    <div class="header-bar">
        <h3>{% if not event.Finalized %}Manage {% endif %}Segments</h3>
        {% if not event.Finalized %}
        <div class="action-buttons">
            <a href="{{ url_for('segments.create_segment', event_slug=event.Event_Name) }}" class="btn btn-primary">Add New Segment</a>
        </div>
        {% endif %}
    </div>
    
    <div class="segment-list">
        {% if segments %}
            {% for segment in segments|sort(attribute='position') %}
                <div class="segment-item">
                    <div class="segment-header">
                        <h4>{{ segment.position }}. {{ segment.type }}{% if segment.header %}: {{ segment.header }}{% endif %}</h4>
                        {% if not event.Finalized %}
                        <div class="action-buttons">
                            <a href="{{ url_for('segments.edit_segment', event_slug=event.Event_Name, position=segment.position) }}" class="btn btn-secondary">Edit</a>
                            <form action="{{ url_for('segments.delete_segment_route', event_slug=event.Event_Name, position=segment.position) }}" method="POST" class="d-inline" onsubmit="return confirmDelete('Are you sure you want to delete segment {{ segment.position }}?');">
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                     <div class="segment-content">
                         {% if segment.participants_display %}
                            <p class="participants-display"><strong>Participants:</strong> {{ segment.participants_display }}</p>
                         {% endif %}
                         {% if segment.type == 'Match' and segment.match_result %}
                             <p class="match-result"><strong>Result:</strong> {{ segment.match_result }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No segments found for this event. {% if not event.Finalized %}Click "Add New Segment" to get started.{% endif %}</p>
        {% endif %}
    </div>
    
    {% if event.Status == 'Past' and not event.Finalized %}
    {% if event_warnings|length > 0 %}
    <hr class="section-divider">
    <div class="warnings-section">
        <h3>Warnings</h3>
        <p class="text-danger">The following issues were found in your event's matches. Please review them before finalizing.</p>
        <ul class="list-group mb-3">
            {% for warning in event_warnings %}
            <li class="list-group-item list-group-item-warning">{{ warning }}</li>
            {% endfor %}
        </ul>
        </div>
    </div>
    {% endif %}

    <hr class="section-divider">
    <div class="finalize-section">
        <h3>Finalize Event</h3>
        <p>Finalizing an event is an irreversible action. It will update all wrestler and tag team records and process any championship changes based on the match results. The event and its segments will become read-only.</p>
        <form action="{{ url_for('events.finalize_event', event_name=event.Event_Name) }}" method="POST">
            {% if event_warnings|length > 0 %}
            <div class="form-group">
                <input type="checkbox" id="acknowledge_warnings" name="acknowledge_warnings">
                <label for="acknowledge_warnings">I acknowledge these warnings and wish to proceed with finalization.</label>
            </div>
            {% endif %}
            <button type="submit" id="finalize_button" class="btn btn-success btn-lg">Finalize Event and Update All Records</button>
        </form>
    </div>
    {% endif %}

    {% endif %}
{% endblock %}

